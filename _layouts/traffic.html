<!DOCTYPE html>
<html lang="en">
<head>
{% include html/metadata.html %}
{% include html/fontface.html %}
{% include html/fontawesome.html %}
<style>
{% include css/traffic.css %}
</style>
{% seo %}
</head>
<body id="home">
  <main>
    <div class="container">
      {% include html/backhome.html %}
      <section>
        <h1 class="heading">Traffic</h1>
        <p>
          <i class="fa fa-external-link"></i>
          <a href="https://play.google.com/store/apps/details?id=com.id1tpnpcj1ylo4kbx4m88o">Android app</a>
        </p>
        <h2 class="lead" id="incidents-label" style="display:none">Incidents</h2>
        <div id="incidents"></div>
        <h2 class="lead">Entering Lisbon from the South, via 25 de Abril bridge</h2>
        <div id="south_cams" class="cams"></div>
        <div style="clear: both"></div>
      </section>
      <section>
        <h2 class="lead">Leaving Lisbon to the South, via 25 de Abril bridge</h2>
        <div id="north_cams" class="cams"></div>
        <div style="clear: both"></div>
      </section>
    </div>
  </main>
  {% include html/footer.html %}
  <script>
    {% include js/fontface_observer.js %}
    {% include js/register_service_worker.js %}
    {% include js/galite.js %}
    {% include js/modernizr.js %}
    document.addEventListener("DOMContentLoaded", function () {
      var jsonURL = 'https://joaobordalo.com/images/traffic/incidents.json?'
                  + new Date().getTime();
      fetch(jsonURL)
        .then(r => r.json())
        .then(data => {
          if (data.length > 0) {
            document.getElementById('incidents-label').style.display = 'block';
            var container = document.getElementById('incidents')
            data.forEach(incident => {
              var iconContainer = document.createElement('div');
              iconContainer.innerHTML = '<p><i class="fa fa-warning"></i></p>';
              var textContainer = document.createElement('div');
              textContainer.innerHTML = '<p>' + incident.descricaoIncidencia + '</p>';
              var div = document.createElement('div');
              div.appendChild(iconContainer);
              div.appendChild(textContainer);
              container.appendChild(div);
            });
          }
        });
      const placeholder = 'https://cdn.joaobordalo.com/images'
                        + '/static/traffic/placeholder.png';
      ['south_cams', 'north_cams'].forEach(function (div_id) {
        var camIDs = {
          south_cams: [305, 306, 307, 5, 308, 309, 310, 311, 7, 312, 313, 149, 532, 314, 316],
          north_cams: [78, 79, 80, 81]
        };
        var div = document.getElementById(div_id);
        camIDs[div_id].forEach(function (camID) {
          var col = document.createElement('div');
          col.classList.add('text_column');
          var url = 'https://joaobordalo.com/images/traffic/viaverde_' + camID + '.jpeg?' + new Date().getTime();
          var img = document.createElement('img');
          img.src = url;
          img.alt = 'Cam ID ' + camID;
          img.onerror = function() { img.src = placeholder; }
          col.appendChild(img);
          div.appendChild(col);
        });
      });
    });
  </script>
</body>
</html>
